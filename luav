#!/bin/bash

# luav - Lua version manager
# Required: coreutils(cat type cd rm ln fmt sort) grep
# Optional:
#   sudo apt [installing any missing packages]
#   wget tar [any downloading/unpacking]
#   find libreadline-dev [install lua]
#   liblua5.3-dev liblua5.2-dev liblua5.1-dev [install luajit]

Ver=0.14 Arch=linux Luav_dir="$HOME/.luav"  # Directory tree for luav

Usage(){
	cat <<-EOT
		luav-$Ver - Lua version manager
		Usage:  luav <command> [<component>[-<version>]]
		            <component>:  lua | [lua]jit | [lua]rocks
		            <version>:    n.n[.n[n]][b[n]] (n:0-9, b:'-beta')
		            <command>:    all | list | current [<component>]
		                          install | use | uninstall <component>-<version>
		                          version | help
		    luav install | use | uninstall <component>-<version>
		      - Install / Use / Uninstall the given version of lua/luarocks/luajit
		    luav all | list | current  [lua | [lua]rocks | [lua]jit]
		      - List Known / Installed / Current versions of lua/luarocks/luajit
		    luav version    - Display luav version
		    luav [help]     - Display this help text
		
		Examples:
		    luav install lua-5.3.5         Install latest version of lua 5.3
		    luav install lua-5.2.4         Install latest version of lua 5.2
		    luav install lua-5.1.5         Install latest version of lua 5.1
		    luav install luarocks-3.0.4    Install latest luarocks version
		    luav install luajit-2.0.5      Install latest luajit version
		Directory tree for luav: $Luav_dir
	EOT
}

Error(){ echo -e "\e[1m\e[31m$1\n\e[0m" 1>&2; exit 1;}
Print(){ echo -e "\e[1m  $1\e[0m";}
Exists(){ type "$1" &>/dev/null || Error "'$1' must be usable";}
Exec_command(){ eval $1; (($?)) && Error "ABORT: error in executing '$1'";}

Download(){ # $1:url
	Print "Downloading from $1"
	Exists wget
	Exec_command "wget -q '$1'"
	Print "Download successful"
}

Unpack(){ # $1:archive
	Print "Unpacking $1"
	Exists tar
	Exec_command "tar xf '$1'"
	Print "Unpack successful"
}

Download_unpack(){ # $1:name $2:archive $3:url
	if [[ -e $1 ]]
	then
		read -rn1 -p "'$1' already downloaded, download anew? [y/N] "
		[[ $REPLY ]] && echo
		[[ $REPLY =~ [yY] ]] && Exec_command "rm -r '$1'"
	fi
	if [[ ! -e $1 ]]
	then # Downloading the archive only if it does not exist
		Print "Downloading $1"
		Download "$3/$2"
		Print "Extracting $2"
		Unpack "$2"
		Exec_command "rm '$2'"
	fi
}

Uninstall(){ # $1:name $2:path $3:dir
	Print "Uninstalling $1"
	Exec_command "cd '$2'"
	[[ -e $3 ]] || Error "$1 not installed"
	Exec_command "rm -r '$3'"
	Print "Successfully uninstalled $1"
}

Get_arch(){
	local arch=$(uname -s)
	Print "Detecting architecture"
	case "$arch" in
		Linux) Arch=linux ;;
		FreeBSD) Arch=freebsd ;;
		*BSD*) Arch=bsd ;;
		CYGWIN*|MINGW*|MSYS*) Arch=mingw ;;
		AIX) Arch=aix ;;
		SunOS) Arch=solaris ;;
		*) Arch=posix
			Print "Unknown architecture $arch, using 'posix'"
	esac
}

Get_lua_ver(){
	local ver=$(readlink "$Bin_dir/lua")
	ver=${ver#$Lua_dir/} Lua_ver=${ver%/bin/lua}
	Lua_sver=${Lua_ver:0:3}
}

Get_rocks_ver(){
	local ver=$(readlink "$Bin_dir/luarocks")
	ver=${ver#$Rocks_dir/} ver=${ver%/bin/luarocks}
	Rocks_ver=${ver%_*}
	Lua_rver=${ver#*_}
}

Get_jit_ver(){
	local ver=$(readlink "$Bin_dir/luajit")
	ver=${ver#$Jit_dir/} Jit_ver=${ver%/bin/luajit}
}

Do_list_lua(){
	local vers=$(ls -1 $Lua_dir) ver
	[[ -z $vers ]] && Print "No lua versions installed" && return
	Get_lua_ver
	for ver in $vers
	do
		[[ $ver = $Lua_ver ]] &&
			Print "lua-$ver <--current" ||
			Print "lua-$ver"
	done
}

Do_list_rocks(){
	local vers=$(ls -1 $Rocks_dir) ver rocks lua
	[[ -z $vers ]] && Print "No luarocks versions installed" && return
	Get_rocks_ver
	for ver in $vers
	do
		rocks=${ver%_*} lua=${ver#*_}
		[[ $rocks = $Rocks_ver && $lua = $Lua_rver ]] &&
			Print "luarocks-$rocks (lua version: $lua) <--current" ||
			Print "luarocks-$rocks (lua version: $lua)"
	done
}

Do_list_jit(){
	local vers=$(ls -1 $Jit_dir) ver
	[[ -z $vers ]] && Print "No LuaJIT versions installed" &&
		return
	Get_jit_ver
	for ver in $vers
	do
		[[ $ver = $Jit_ver ]] &&
			Print "LuaJIT-$ver <--current" ||
			Print "LuaJIT-$ver"
	done
}

Do_current_lua(){
	Get_lua_ver
	[[ $Lua_ver ]] && Print "lua-$Lua_ver" ||
		Print "No lua versions installed"
}

Do_current_rocks(){
	Get_rocks_ver
	[[ $Rocks_ver ]] && Print "luarocks-$Rocks_ver" ||
		 Print "No luarocks versions installed"
}

Do_current_jit(){
	Get_jit_ver
	[[ $Jit_ver ]] && Print "LuaJIT-$Jit_ver" ||
		 Print "No LuaJIT versions installed"
}

Do_all_lua(){
	local f
	if [[ -z $Luav ]]
	then
		Exists wget
		f=($(wget -qO- "$Urllua" |grep -o 'lua-[.0-9]*tar\.gz' |sort -u))
		f=(${f[@]#lua-})
		Luav=${f[@]%\.tar\.gz}
	fi
	Print "All known lua verion:"
	fmt <<<${Luav// /  }
}

Do_all_rocks(){
	local f
	if [[ -z $Rocksv ]]
	then
		Exists wget
		f=($(wget -qO- "$Urlrocks" |grep -o 'luarocks-[.0-9]*tar\.gz' |sort -u))
		f=(${f[@]#luarocks-}) Rocksv=${f[@]%\.tar\.gz}
	fi
	Print "All known luarocks versions:"
	fmt <<<${Rocksv// /  }
}

Do_all_jit(){
	local f
	if [[ -z $Jitv ]]
	then
		Exists wget
		f=($(wget -qO- "$Urljit.html" |grep -o 'LuaJIT[^ ]*\.tar\.gz$' |sort -u))
		f=(${f[@]#LuaJIT-})
		Jitv=${f[@]%\.tar\.gz}
	fi
	Print "All known LuaJIT versions:"
	fmt <<<${Jitv// /  }
}

Do_install_lua(){ # $1:version
	local name="lua-$1"
	((${1:0:1}${1:2:1}<51)) && Error "$name too old to autobuild"
	[[ $Luav ]] || Do_all_lua >/dev/null
	[[ ' '$Luav' ' == *' '$1' '* ]] || Error "$name is not available"
	Print "Installing $name"
	! find /usr/include |grep -q readline/readline.h &&
		if type -p apt &>/dev/null
		then sudo apt install libreadline-dev
		else Error "Missing 'readline/readline.h', install package libreadline-dev"
		fi
	Exec_command "cd '$Src_dir'"
	Download_unpack "$name" "$name.tar.gz" "$Urllua"
	Get_arch
	Exec_command "cd '$name'"
	Print "Compiling $name"
	Exec_command "make $Arch install INSTALL_TOP=$Lua_dir/$1/"
	read -rn1 -p "$name successfully installed. Use this version? [Y/n] "
	[[ $REPLY ]] && echo
	[[ $REPLY =~ ^[nN]$ ]] || Do_use_lua $1
}

Do_install_rocks(){ # $1:version
	local name="luarocks-$1"
	((${1:0:1}${1:2:1}<22)) && Error "$name too old to autobuild"
	[[ $Rocksv ]] || Do_all_rocks >/dev/null
	[[ ' '$Rocksv' ' == *' '$1' '* ]] || Error "$name not available"
	Get_lua_ver
	[[ $Lua_ver ]] || Error "No lua version set, install lua first"
	Print "Installing $name for lua $Lua_sver"
	Exec_command "cd '$Src_dir'"
	mkdir -p "$Inc_dir"
	[[ ! -e "$Inc_dir/lua$Lua_sver" ]] &&
		! ln -s "/usr/include/lua$Lua_sver" "$Inc_dir/" &&
		Error "Can't link the header files of Lua $Lua_sver"
	Download_unpack "$name" "$name.tar.gz" "$Urlrocks"
	Exec_command "cd '$name'"
	Print "Compiling $name"
	Exec_command "./configure --prefix=$Rocks_dir/$1_$Lua_sver
			--with-lua=$Lua_dir/$Lua_ver
			--with-lua-bin=$Lua_dir/$Lua_ver/bin
			--with-lua-include=$Lua_dir/$Lua_ver/include
			--with-lua-lib=$Lua_dir/$Lua_ver/lib
			--versioned-rocks-dir"
	Exec_command "make build"
	Exec_command "make install"
	read -rn1 -p "$name successfully installed. Use this version? [Y/n] "
	[[ $REPLY ]] && echo
	[[ $REPLY =~ ^[nN]$ ]] || Do_use_rocks $1
}

Do_install_jit(){ # $1:version
	local name="LuaJIT-$1"
	((${1:0:1}<2)) && Error "$name too old to autobuild"
	[[ $Jitv ]] || Do_all_jit >/dev/null
	[[ ' '$Jitv' ' == *' '$1' '* ]] || Error "$name is not available"
	Print "Installing $name"
	Exec_command "cd '$Src_dir'"
	Download_unpack "$name" "$name.tar.gz" "$Urljit"
	Exec_command "cd '$name'"
	Print "Compiling $name (needs package liblua${1:2:3}-dev!)"
	Get_arch
	Exec_command "make PREFIX='$Jit_dir/$1'"
	Exec_command "make install PREFIX='$Jit_dir/$1'"
	Exec_command "cd '$Jit_dir/$1/bin'"
	[[ -f luajit ]] || Exec_command "ln -sf 'luajit-$1' '$Jit_dir/$1/bin/luajit'"
	read -rn1 -p "$name successfully installed. Use this version? [Y/n] "
	[[ $REPLY ]] && echo
	[[ $REPLY =~ ^[nN]$ ]] || Do_use_jit $1
}

Do_use_lua(){ # $1:version
	local name="lua-$1"
	Print "Starting to use $name"
	Exec_command "cd $Lua_dir"
	if [[ ! -e $1 ]]
	then
		read -rn1 -p "$name is not installed. Install? [Y/n] "
		[[ $REPLY ]] && echo
		[[ $REPLY =~ ^[nN]$ ]] && Print "Unable to use $name, not installed" &&
			return
		Do_install_lua $1
	fi
	Exec_command "cd '$Bin_dir'"
	[[ -L lua ]] && Exec_command "rm lua"
	[[ -L luac ]] && Exec_command "rm luac"
	Exec_command "ln -s '$Lua_dir/$1/bin/lua'"
	Exec_command "ln -s '$Lua_dir/$1/bin/luac'"
	Print "Successfully using $name now"

	if [[ -L luarocks ]]
	then # Check if lua version of luarocks matches
		Get_lua_ver
		Get_rocks_ver
		if [[ ! $Lua_sver = $Lua_rver ]]
		then
			Print "Current version of luarocks does not match current lua version"
			Exec_command "rm luarocks"
			Exec_command "rm luarocks-admin"
			Do_use_rocks $Rocks_ver
		fi
	fi
}

Do_use_rocks(){ # $1:version
	local name="luarocks-$1"
	Get_lua_ver
	Print "Using $name with lua $Lua_sver"
	Exec_command "cd '$Rocks_dir'"
	if [[ ! -e $1_$Lua_sver ]]
	then
		read -rn1 -p "'$name' not installed with lua $Lua_sver. Install? [Y/n] "
		[[ $REPLY ]] && echo
		[[ $REPLY =~ ^[nN]$ ]] && Print "Can't use $name, not installed" &&
			return
		Do_install_rocks $1
	fi
	Exec_command "cd '$Bin_dir'"
	[[ -L luarocks ]] && Exec_command "rm luarocks"
	[[ -L luarocks-admin ]] && Exec_command "rm luarocks-admin"
	Exec_command "ln -s '$Rocks_dir/$1_$Lua_sver/bin/luarocks'"
	Exec_command "ln -s '$Rocks_dir/$1_$Lua_sver/bin/luarocks-admin'"
	Print "Successfully using $name now"
}

Do_use_jit(){ # $1:version
	local name="LuaJIT-$1"
	Print "Using $name"
	Exec_command "cd '$Jit_dir'"
	if [[ ! -e $1 ]]
	then
		read -rn1 -p "LuaJIT '$name' not installed. Install? [Y/n] "
		[[ $REPLY ]] && echo
		[[ $REPLY =~ ^[nN]$ ]] && Print "Can't use $name, not installed" &&
			return
		Do_install_jit $1
	fi
	Exec_command "cd '$Bin_dir'"
	[[ -L luajit ]] && Exec_command "rm luajit"
	Exec_command "ln -s '$Jit_dir/$1/bin/luajit'"
	Print "Successfully using $name now"
}

Do_uninstall_lua(){ # $1:version
	local name="lua-$1"
	Get_lua_ver
	Uninstall "$name" "$Lua_dir" "$Lua_ver"
	if [[ $1 = $Lua_ver ]]
	then
		Exec_command "cd '$Bin_dir'"
		Exec_command "rm lua"
		Exec_command "rm luac"
	fi
}

Do_uninstall_rocks(){ # $1:version
	local name="luarocks-$1"
	Get_lua_ver
	Get_rocks_ver
	Print "Uninstalling $name for lua $Lua_sver"
	Uninstall "$name" "$Rocks_dir" "$1_$Lua_sver"
	if [[ $1 = $Rocks_ver ]]
	then
		Exec_command "cd '$Bin_dir'"
		Exec_command "rm luarocks"
		Exec_command "rm luarocks-admin"
	fi
}

Do_uninstall_jit(){ # $1:version
	local name="LuaJIT-$1"
	Get_jit_ver
	Uninstall "$name" "$Jit_dir" "$1"
	if [[ $1 = $Jit_ver ]]
	then
		Exec_command "cd '$Bin_dir'"
		Exec_command "rm luajit"
	fi
}

# Download urls
Urllua='http://www.lua.org/ftp'
Urljit='http://luajit.org/download'
Urlrocks='http://luarocks.org/releases'

# Directory tree
Src_dir="$Luav_dir/src"  # Source code dir
Bin_dir="$Luav_dir/bin"  # Bin_dirary/link dir
Lua_dir="$Luav_dir/lua"  # Build dir for lua
Rocks_dir="$Luav_dir/luarocks"  # Build dir for luarocks
Jit_dir="$Luav_dir/luajit"  # Build dir for luajit
Inc_dir="$Luav_dir/include"  # Inc_dirlude dir
mkdir -p "$Src_dir" "$Lua_dir" "$Jit_dir" "$Rocks_dir" "$Bin_dir"

# Version globals
Lua_ver= Lua_sver= Lua_rver= Jit_ver= Rocks_ver= Luav=() Jitv=() Rocksv=()

case $1 in
	install|use|uninstall) [[ $2 ]] ||
			Error "Missing argument: lua|[lua]rocks|[lua]jit-<version>"
		declare -l c=${2%%-*}
		[[ $c = lua || $c = luarocks || $c = luajit || $c = rocks || $c = jit ]] ||
			Error "Argument '$2' must start with lua- / [lua]rocks- / [lua]jit-"
		[[ $c = luarocks ]] && c=rocks
		[[ $c = luajit ]] && c=jit
		n=${2#*-}
		egrep '^[0-9]\.[0-9](\.[0-9][0-9]?(-beta[0-9][0-9]?)?)?$' <<<"$n" ||
			Error "Argument '$2' must end in '-n.n[.n[n][bn[n]]]' (n:0-9, b:'-beta')"
		Do_$1_$c "$n" ;;
	all|list|current) [[ -z $2 || $2 = lua || $2 = luarocks || $2 = luajit || \
				$2 = rocks || $2 = jit ]] ||
			Error "Argument '$2' must be empty or: lua / [lua]rocks / [lua]jit"
		c=$2
		[[ $c = luarocks ]] && c=rocks
		[[ $c = luajit ]] && c=jit
		if [[ $c ]]
		then Do_$1_$c
		else
			Do_$1_lua
			Do_$1_jit
			Do_$1_rocks
		fi ;;
	version) echo "luav-$Ver" ;;
	help|'') Usage ;;
	*) Usage
		Error "Unknown first argument: $1"
esac

exit 0
